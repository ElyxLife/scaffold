# CLAUDE.md

## Key Development Patterns

### Backend Development
- Use uv for dependency management (not pip/poetry)
- SQLAlchemy models with proper type hints
- FastAPI with async/await patterns
- Environment-based configuration via config.py
- Comprehensive test coverage with pytest

### Frontend Development
- TypeScript for all components
- shadcn/ui for consistent UI components
- Tailwind CSS for styling
- Path aliases: `@/*` points to `src/`
- Component organization: pages/, components/, services/, hooks/

### Database Operations
- Use Alembic for schema migrations
- Proper foreign key relationships and constraints
- Transaction management for multi-table operations
- Connection pooling via SQLAlchemy

### Error Handling
- Comprehensive error logging throughout the application
- Input validation and sanitization
- Graceful degradation for failed external service calls
- Structured error responses with appropriate HTTP status codes

### Secret Management
- Sensitive values (API keys, tokens, passwords) are stored in `terraform.auto.tfvars.secrets` (gitignored)
- Use `terraform.auto.tfvars.secrets.example` as a template for required secrets
- Non-sensitive configuration goes in `terraform.tfvars`
- Terraform reads secrets from `.tfvars.secrets` and creates/manages them in Google Secret Manager
- **Never commit actual secret values to git**

## Testing Guidelines

### Backend Testing
- Tests use in-memory SQLite for isolation
- Mock external API calls in unit tests
- Use pytest fixtures for database setup
- Input validation can be bypassed with test configurations
- Target coverage: >80%

### Frontend Testing
- Vitest with React Testing Library
- Component testing with proper mocking
- API client testing with axios mocking

## Infrastructure Notes

- **Deployment**: Fully automated via Terraform with GCP Cloud Run, Cloud SQL, and Firebase Hosting
- **State Management**: Terraform uses remote state stored in GCS bucket (see backend.tf)
- **Docker**: Backend containerized with multi-stage builds
- **Secrets**: Managed via Google Secret Manager, referenced in Terraform
- **Monitoring**: Cloud Run logging and monitoring enabled

## Secrets and Authentication

This project requires **ZERO GitHub repository secrets** thanks to modern security practices:

**Project IDs** → Read from `terraform.tfvars.staging` and `terraform.tfvars.prod` files  
**Authentication** → Handled securely via Workload Identity Federation  
**External API Secrets** → Stored in Google Secret Manager  
**Database Passwords** → Auto-generated by Terraform  

### How Secrets Are Managed

#### 🔐 Workload Identity Federation
- **GitHub Actions** authenticates using OIDC tokens (no service account keys!)
- **Short-lived tokens** that expire after each workflow run
- **Repository-specific** authentication for enhanced security
- **Automatic rotation** - no manual key management required

#### 🗝️ External API Secrets
- **Local Development**: Read from `terraform.auto.tfvars.secrets.staging/prod` files (never committed)
- **Initial Deployment**: Terraform stores secrets in Google Secret Manager
- **Runtime**: Applications read secrets via Terraform data sources
- **CI/CD**: GitHub Actions automatically reads from Secret Manager

#### 🔑 Database Credentials
- **Fully Automated**: Terraform generates secure 32-character passwords using `random_password` resource
- **Persistent**: Passwords stored in Terraform state and reused across deployments
- **Secure**: Passwords never appear in logs, scripts, or deployment processes
- **No Manual Management**: Zero password rotation or storage required

#### 📁 Configuration File Management

**✅ Committed to Repository:**
```bash
terraform.tfvars.staging        # Project configuration
terraform.tfvars.prod          # Project configuration
```

**❌ Never Committed (Local Only):**
```bash
terraform.auto.tfvars.secrets.staging    # API secrets for initial setup
terraform.auto.tfvars.secrets.prod      # API secrets for initial setup
```

**🔒 Stored in Google Secret Manager:**
```bash
API_KEY              # Automatically managed after initial deployment
WEBHOOK_SECRET       # Automatically managed after initial deployment
DATABASE_PASSWORD    # Automatically managed after initial deployment
```

### Security Benefits

- 🔐 **Zero Long-lived Keys**: No service account keys stored anywhere
- ⏰ **Auto-expiring Tokens**: Authentication tokens expire after each run
- 🎯 **Repository-specific**: Only your specific repository can authenticate
- 📊 **Better Audit Trail**: Detailed identity information in GCP logs
- 🏗️ **Future-proof**: Industry standard for cloud authentication

**Result**: Reduced secrets to **ZERO GitHub secrets** while significantly improving security! 🚀